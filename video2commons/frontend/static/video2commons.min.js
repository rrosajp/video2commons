(o=>{var r,d,i,a,s,l=window.config,c=window.i18n,t='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',e="rtl"===c["@dir"],u={abortbutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> '+nunjucks.lib.escape(c.abort)+"</button>",removebutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-trash"></span> '+nunjucks.lib.escape(c.remove)+"</button>",restartbutton:'<button type="button" class="btn btn-warning btn-xs flip pull-right"><span class="glyphicon glyphicon-repeat"></span> '+nunjucks.lib.escape(c.restart)+"</button>",loading:"<center>"+t+"&nbsp;&nbsp;"+nunjucks.lib.escape(c.loading)+"</center>",errorDisconnect:'<div class="alert alert-danger">'+nunjucks.lib.escape(c.errorDisconnect)+"</div>",yourTasks:"<h4>"+nunjucks.lib.escape(c.yourTasks)+'</h4><table id="tasktable" class="table"><tbody></tbody></table>',addTask:'<input class="btn btn-primary btn-success btn-md" type="button" accesskey="n" value="'+nunjucks.lib.escape(c.addTask)+'">',requestServerSide:'<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">'+nunjucks.lib.escape(c.createServerSide)+"</a>",progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:'<span class="glyphicon glyphicon-chevron-'+(e?"right":"left")+'"></span> '+nunjucks.lib.escape(c.back),nextbutton:nunjucks.lib.escape(c.next)+' <span class="glyphicon glyphicon-chevron-'+(e?"left":"right")+'"></span>',confirmbutton:nunjucks.lib.escape(c.confirm)+' <span class="glyphicon glyphicon-ok"></span>'},f="",p=(new nunjucks.Environment).addGlobal("config",l).addGlobal("_",function(e){return c[e]}).addFilter("process_link",function(e){for(var t,n=/\{\{#a\}\}(.*?)\{\{\/a\}\}/g,a=0,s="";null!==(t=n.exec(e));)s=(s+=nunjucks.lib.escape(e.substring(a,t.index)))+(e=>{if("#"===e[0]){var t=e.indexOf("|");if(t<0){if(/^[a-z0-9-]+$/i.test(e.slice(1)))return'<a id="'+e.slice(1)+'"></a>'}else if(/^[a-z0-9-]+$/i.test(e.substring(1,t)))return'<a id="'+e.substring(1,t)+'">'+nunjucks.lib.escape(e.slice(t+1))+"</a>"}return"<a>"+nunjucks.lib.escape(e)+"</a>"})(t[1]),a=n.lastIndex;return s+=nunjucks.lib.escape(e.slice(a)),new nunjucks.runtime.SafeString(s)}),m=window.video2commons={init:function(){o("#content").html(u.loading),a={},m.loadCsrf(m.checkStatus),o(window).on("beforeunload",function(e){if(r&&r.is(":visible"))return e.preventDefault(),e.returnValue=""});var e=/^#?!(https?:\/\/.+)/;e.test(window.location.hash)?m.addTask({url:window.location.hash.match(e)[1]}):window.location.search.slice(1)&&(i=Qs.parse(window.location.search.slice(1)),m.addTask({url:i.url}))},loadCsrf:function(t){o.get("api/csrf").done(function(e){f=e.csrf,t()})},checkStatus:function(){l.socketio_uri&&window.WebSocket&&window.io?m.checkStatusSocket():m.checkStatusLegacy()},checkStatusSocket:function(){var e,t,n;window.socket||(t=(e=l.socketio_uri.match(/^((?:(?:https?:)?\/\/)?[^/]+)(\/.*)$/))[1],(n=window.socket=io(t,{path:e[2]})).on("connect",function(){o.get("api/iosession").done(function(e){n.emit("auth",{iosession:e.iosession,_csrf_token:f})})}),n.on("status",function(e){m.alterTaskTableBoilerplate(function(){m.populateResults(e)})}),n.on("update",function(e,t){m.alterTaskTableBoilerplate(function(){m.updateTask(t)})}),n.on("remove",function(e){m.alterTaskTableBoilerplate(function(){o("#task-"+e).remove()})}))},checkStatusLegacy:function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);o.get("api/status").done(function(e){m.alterTaskTableBoilerplate(function(){m.populateResults(e)}),window.lastStatusCheck=setTimeout(m.checkStatusLegacy,5e3)}).fail(function(){o("#content").html(u.errorDisconnect)})},setupTables:function(){o("#content").html(u.yourTasks);var e=o(u.addTask),e=(o("#content").append(e),e.click(function(){m.addTask()}),o(u.requestServerSide));o("#content").append(e.hide())},alterTaskTableBoilerplate:function(e){o("#tasktable").length||m.setupTables();var t=window.innerHeight+window.scrollY>=document.body.offsetHeight;e(),o.isEmptyObject(a)?o("#ssubtn").addClass("disabled").hide():o("#ssubtn").removeClass("disabled").show().attr("href",m.makeSSULink(a)),t&&window.scrollTo(0,document.body.scrollHeight)},populateResults:function(e){s=e.username;var t=o("#tasktable > tbody"),n=[];o.each(e.values,function(e,t){m.updateTask(t),n.push(t.id)}),t.find("> tr").each(function(){var e=o(this),t=m.getTaskIDFromDOMID(e.attr("id"));n.indexOf(t)<0&&e.remove()})},updateTask:function(e){function t(e,t,n){var a=i.find("#"+s+"-statustext");t?(t=a.html(e).find("a").attr("href",t),n&&t.text(n)):a.text()!==e&&a.text(e)}var n=o("#tasktable > tbody"),s="task-"+e.id,i=o("#"+s),n=(i.length?i.attr("status")!==e.status&&(i.html(""),m.setupTaskRow(i,s,e.status)):(o("#task-new").remove(),(i=o("<tr />")).attr({id:s,status:e.status}),n.append(i),m.setupTaskRow(i,s,e.status)),i.find("#"+s+"-title"));n.text()!==e.title&&n.text(e.title);"done"===e.status?t(p.getFilter("process_link")(c.taskDone).toString(),e.url.replace("%3A",":"),e.text):"needssu"===e.status?t(p.getFilter("process_link")(c.errorTooLarge).toString(),m.makeSSULink([e])):"fail"===e.status?(t(e.text),e.restartable?i.find("#"+s+"-restartbutton").show().off().click(function(){m.eventTask(this,"restart")}):i.find("#"+s+"-restartbutton").off().hide()):t(e.text),"progress"===e.status&&m.setProgressBar(i.find("#"+s+"-progress"),e.progress),"needssu"===e.status?a[e.id]=e:delete a[e.id]},setupTaskRow:function(e,t,n){switch(n){case"progress":e.append(o("<td />").attr("id",t+"-title").attr("width","30%")).append(o("<td />").attr("id",t+"-status").attr("width","40%").append(o("<span />").attr("id",t+"-statustext"))).append(o("<td />").attr("id",t+"-progress").attr("width","30%"));var a=m.eventButton(t,"abort"),a=(e.find("#"+t+"-status").append(a),e.find("#"+t+"-progress").html(u.progressbar));m.setProgressBar(a,-1),e.removeClass("success danger");break;case"done":m.appendButtons([m.eventButton(t,"remove")],e,["danger","success"],t);break;case"fail":var a=m.eventButton(t,"remove"),s=m.eventButton(t,"restart").hide();m.appendButtons([a,s],e,["success","danger"],t);break;case"needssu":m.appendButtons([m.eventButton(t,"remove")],e,["success","danger"],t);break;case"abort":m.appendButtons([],e,["success","danger"],t)}e.attr("status",n)},makeSSULink:function(e){var t=o.map(e,function(e){return"* "+e.url}).join("\n"),e=o.map(e,function(e){return"| "+e.filename+" | "+e.hashsum+" |"}).join("\n");return"https://phabricator.wikimedia.org/maniphest/task/edit/form/106/?"+o.param({title:"Server side upload for "+s,projects:"video2commons,server-side-upload-request",description:"Please upload these file(s) to Wikimedia Commons:\n\n**URLs**\n\n{{{ urls }}}\n\n//Description files are available too: append `.txt` to the URLs.//\n\n**Checksums**\n\n| **File** | **MD5** |\n{{{ checksums }}}\n\nThank you!".replace("{{{ urls }}}",t).replace("{{{ checksums }}}",e)})},setProgressBar:function(e,t){e=e.find(".progress-bar");t<0?(e.addClass("progress-bar-striped active").addClass("active").text(""),t=100):e.removeClass("progress-bar-striped active").text(Math.round(t)+"%"),e.attr({"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+t+"%"})},getTaskIDFromDOMID:function(e){return/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(e)[1]},eventTask:function(e,t){e=o(e);e.is(".disabled")||(e.off().addClass("disabled"),m.apiPost("task/"+t,{id:m.getTaskIDFromDOMID(e.attr("id"))}).done(function(e){e.error&&window.alert(e.error),m.checkStatus()}))},setText:function(e,t){for(var n=0;n<e.length;n++)r.find("#"+e[n]).text(t[e[n]])},eventButton:function(e,t){return o(u[t+"button"]).attr("id",e+"-"+t+"button").off().click(function(){m.eventTask(this,t)})},appendButtons:function(e,t,n,a){t.append(o("<td />").attr("id",a+"-title").attr("width","30%"));var s=o("<td />").attr("id",a+"-status").attr("width","70%").attr("colspan","2").append(o("<span />").attr("id",a+"-statustext"));e.length&&s.append(e[0]);for(var i=1;i<e.length;i++)s.append(e[i]);t.append(s).removeClass(n[0]).addClass(n[1])},addTask:function(e){r||((r=o("<div>").html(p.render("addTask.html"))).addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),o("body").append(r),r.find("#btn-prev").html(u.prevbutton),r.find("#btn-next").html(u.nextbutton),r.find("#btn-cancel").click(function(){m.abortUpload()}),r.find(".modal-body").keypress(function(e){13!==(e.which||e.keyCode)||o(":focus").is("textarea")||(r.find(".modal-footer #btn-next").click(),e.preventDefault())})),m.openTaskModal(e)},openTaskModal:function(e){r.find("#dialog-spinner").hide(),r.find(".modal-body").html("<center>"+t+"</center>"),m.newTask(e),r.modal({backdrop:"static"}),r.on("shown.bs.modal",function(){r.find("#url").focus()}),m.reactivatePrevNextButtons()},newTask:function(e){d={step:"source",url:"",extractor:"",audio:!0,video:!0,subtitles:!0,filename:!0,formats:[],format:"",filedesc:"",uploadedFile:{},filenamechecked:!1,filedescchecked:!1,filenameuniquechecked:!1},o.extend(d,e),m.setupAddTaskDialog()},setupAddTaskDialog:function(){switch(d.step){case"source":r.find(".modal-body").html(p.render("sourceForm.html")),r.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),r.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),r.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),r.find("#url").val(d.url).focus(),r.find("#video").prop("checked",d.video),r.find("#audio").prop("checked",d.audio),r.find("#subtitles").prop("checked",d.subtitles),m.initUpload();break;case"target":r.find(".modal-body").html(p.render("targetForm.html")),r.find("#filename").val(d.filename.trim()).focus(),o.each(d.formats,function(e,t){r.find("#format").append(o("<option></option>").text(t))}),r.find("#format").val(d.format),r.find("#filedesc").val(d.filedesc);break;case"confirm":r.find(".modal-body").html(p.render("confirmForm.html"));var e=[];d.video&&e.push(c.video),d.audio&&e.push(c.audio),d.subtitles&&e.push(c.subtitles),r.find("#keep").text(e.join(", ")),m.setText(["url","extractor","filename","format"],d),r.find("#filedesc").val(d.filedesc),r.find("#btn-next").focus()}},reactivatePrevNextButtons:function(){switch(r.find("#dialog-spinner").hide(),d.step){case"source":r.find("#btn-prev").addClass("disabled").off(),r.find("#btn-next").html(u.nextbutton),m.setPrevNextButton("next");break;case"target":m.setPrevNextButton("prev"),r.find("#btn-next").html(u.nextbutton),m.setPrevNextButton("next");break;case"confirm":m.setPrevNextButton("prev"),r.find("#btn-next").removeClass("disabled").html(u.confirmbutton).off().click(function(){m.disablePrevNext(!1),r.modal("hide"),o("#tasktable > tbody").append('<tr id="task-new"><td colspan="3">'+t+"</td></tr>"),window.scrollTo(0,document.body.scrollHeight),d.uploadedFile={},m.apiPost("task/run",d).done(function(e){e.error&&window.alert(e.error),m.checkStatus()})})}},setPrevNextButton:function(e){r.find("#btn-"+e).removeClass("disabled").off().click(function(){m.processInput(e)})},disablePrevNext:function(e){r.find(".modal-body #dialog-errorbox").hide(),r.find("#btn-prev").addClass("disabled").off(),r.find("#btn-next").addClass("disabled").off(),e&&r.find("#dialog-spinner").show()},processInput:function(n){var e,t,a,s,i=o.when();switch(d.step){case"source":e=o.when((a=r.find("#video").is(":checked"),s=r.find("#audio").is(":checked"),d.subtitles=r.find("#subtitles").is(":checked"),d.formats.length&&a===d.video&&s===d.audio?i:m.askAPI("listformats",{video:a,audio:s},["video","audio","format","formats"])),(a=r.find("#url").val())?d.filename&&d.filedesc&&a===d.url?i:(d.filenamechecked=!1,d.filedescchecked=!1,d.filenameuniquechecked=!1,(s=d.uploadedFile[a])?(d.url=a,m.askAPI("makedesc",{filename:s.name||""},["extractor","filedesc","filename"])):m.askAPI("extracturl",{url:a},["url","extractor","filedesc","filename"])):o.Deferred().reject("URL cannot be empty!").promise());break;case"target":e=o.when((s=r.find("#filename").val().trim(),d.format=r.find("#format").val(),s?d.filenamechecked&&s===d.filename?i:m.askAPI("validatefilename",{filename:s},["filename"]).done(function(){d.filenamechecked=!0}):o.Deferred().reject("Filename cannot be empty!").promise()),(a=r.find("#filedesc").val())?d.filedescchecked&&a===d.filedesc?i:m.askAPI("validatefiledesc",{filedesc:a},["filedesc"]).done(function(){d.filedescchecked=!0}):o.Deferred().reject("File description cannot be empty!").promise(),(t=r.find("#filename").val().trim())?d.filenameuniquechecked&&t===d.filename?i:m.askAPI("validatefilenameunique",{filename:t},["filename"]).done(function(e){d.filenameuniquechecked=!0}):o.Deferred().reject("Filename cannot be empty!").promise());break;case"confirm":e=i}m.promiseWorkingOn(e.done(function(){var e={prev:-1,next:1}[n],t=["source","target","confirm"];d.step=t[t.indexOf(d.step)+e],m.setupAddTaskDialog()}))},promiseWorkingOn:function(e){return m.disablePrevNext(!0),e.fail(function(e){r.find(".modal-body #dialog-errorbox").length||r.find(".modal-body").append(o('<div class="alert alert-danger" id="dialog-errorbox"></div>')),r.find(".modal-body #dialog-errorbox").text("Error: "+e).show()}).always(m.reactivatePrevNextButtons)},abortUpload:function(e,t){e&&"pending"===e.state()&&e.reject(t),window.jqXHR&&window.jqXHR.abort&&window.jqXHR.abort()},initUpload:function(){var a;window.jqXHR=r.find("#fileupload").fileupload({dataType:"json",formData:{_csrf_token:f},maxChunkSize:4<<20,sequentialUploads:!0}).on("fileuploadadd",function(e,t){window.jqXHR=t.submit(),a=o.Deferred(),m.promiseWorkingOn(a.promise()),r.find("#src-url").hide(),r.find("#src-uploading").show(),r.find("#upload-abort").off().click(function(){m.abortUpload(a,"Upload aborted.")})}).on("fileuploadchunkdone",function(e,t){t.result.filekey&&(t.formData.filekey=t.result.filekey),"Continue"===t.result.result?t.result.offset!==t.uploadedBytes&&m.abortUpload(a,"Unexpected offset! Expected: "+t.uploadedBytes+" Returned: "+t.result.offset):t.result.error?m.abortUpload(a,t.result.error):m.abortUpload()}).on("fileuploadprogressall",function(e,t){m.setProgressBar(r.find("#upload-progress"),t.loaded/t.total*100)}).on("fileuploadalways",function(e,t){delete t.formData.filekey,m.reactivatePrevNextButtons(),r.find("#src-url").show(),r.find("#src-uploading").hide()}).on("fileuploadfail",function(){m.abortUpload(a,"Something went wrong while uploading... try again?")}).on("fileuploaddone",function(e,t){var n;"Success"===t.result.result?(n="uploads:"+t.result.filekey,d.uploadedFile[n]=t.files[0],r.find("#url").val(n),a.resolve()):m.abortUpload(a,"Upload does not seem to be successful.")})},askAPI:function(e,t,a){var s=o.Deferred();return m.apiPost(e,t).done(function(e){if(e.error)s.reject(e.error);else{for(var t=0;t<a.length;t++){var n=a[t];i&&i[n]?d[n]=i[n]:d[n]=e[n]}s.resolve(e)}}).fail(function(){s.reject("Something weird happened. Please try again.")}),s.promise()},apiPost:function(e,t){return t._csrf_token=f,o.post("api/"+e,t)}};o(document).ready(function(){m.init()})})(jQuery);